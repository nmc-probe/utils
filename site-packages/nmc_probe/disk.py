# Copyright (c) 2015 The New Mexico Consortium
#
# {{{NMC-LICENSE
#
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#
# 1. Redistributions of source code must retain the above copyright
# notice, this list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright
# notice, this list of conditions and the following disclaimer in the
# documentation and/or other materials provided with the distribution.
#
# 3. Neither the name of the copyright holder nor the names of its
# contributors may be used to endorse or promote products derived from
# this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
# FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
# COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
# BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS
# OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
# AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
# THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
# DAMAGE.
#
# }}}

import sys
import os
import re

from nmc_probe.hdparm import HDParm
from nmc_probe.smart import Smart
from nmc_probe.proc.diskstats import Diskstats


class Disk:
    def __init__(self, attrs):
        for k, v in attrs.iteritems():
            setattr(self, k, v)

        dev = self.dev

        if dev is not None:
            self.hdparm = HDParm(self.dev)
            self.smart = Smart(self.dev)
            self.model_number = self.hdparm.info['model_number']

    def __repr__(self):
        return '%s' % vars(self)

    def get_a_dev(self):
        '''Try and get a device for this disk based on available attributes'''

        dev = None

        try:
            dev = self.dev_by_pci
        except:
            try:
                dev = self.dev_by_id_wwn
            except:
                try:
                    dev = self.dev_by_id_protocol
                except:
                    try:
                        dev = self.dev_by_id_wwn
                    except:
                        pass
        return dev

    @property
    def dev(self):
        if getattr(self, '_dev', None) is None:
            self._dev = self.get_dev()
        return self._dev

    def get_dev(self):
        dev = self.get_a_dev()
        if dev is None:
            return None
        return os.path.realpath(dev)

    @property
    def dev_by_id_wwn(self):
        if getattr(self, '_dev_by_id_wwn', None) is None:
            self._dev_by_id_wwn = self.get_dev_by_id_wwn()
        return self._dev_by_id_wwn

    @property
    def dev_by_id_protocol(self):
        if getattr(self, '_dev_by_id_protocol', None) is None:
            self._dev_by_id_protocol = self.get_dev_by_id_protocol()
        return self._dev_by_id_protocol

    @property
    def dev_by_pci(self):
        if getattr(self, '_dev_by_pci', None) is None:
            self._dev_by_pci = self.get_dev_by_pci()
        return self._dev_by_pci

    @property
    def id_protocol(self):
        if getattr(self, '_id_protocol', None) is None:
            self._id_protocol = self.get_id_protocol()
        return self._id_protocol

    @property
    def speed(self):
        return self.hdparm.speed

    def get_dev_by_id_wwn(self):
        '''Find the /dev/disk/by-id/dev_name based on the protocol,
        model number and serial number'''
        wwn = getattr(self, 'wwn', None)

        if wwn is None:
            raise Exception('No wwn attribute, cannot find /dev/disk/by-id/wwn-')

        dev = '/dev/disk/by-id/wwn-0x%s' % wwn

        # Check to see if the device exists. If it doesn't, an exception will be
        # thrown
        os.stat(dev)
        return dev

    def get_id_protocol(self):
        '''The device name in /dev/disk/by-id/ based on the protocol,
        model number and serial number'''
        protocol = getattr(self, 'protocol', None)
        serial_number = getattr(self, 'serial_number', None)
        model_number = getattr(self, 'model_number', None)

        if protocol is None:
            raise Exception('No protocol specified, cannot find /dev/disk/by-id/PROTOCOL')

        if serial_number is None:
            raise Exception('No serial_number for drive, cannot find /dev/disk/by-id')

        if model_number is None:
            raise Exception('No model_number number for drive, cannot find /dev/disk/by-id')

        model_number = model_number.replace(' ', '_')
        serial_number = serial_number.replace(' ', '_')

        # Replace spaces in model number with
        if protocol == 'SATA':
            protocol = 'ata'
        elif protocol == 'SAS':
            protocol = 'sas'
        else:
            raise Exception('Protocol %s not recognized, cannot find /dev/disk/by-id/PROTOCOL')

        return '%s-%s_%s' % (protocol, model_number, serial_number)

    def get_dev_by_id_protocol(self):
        '''Find the /dev/disk/by-id/dev_name based on the protocol,
        model number and serial number'''

        dev = '/dev/disk/by-id/%s' % self.id_protocol

        # Check to see if the device exists. If it doesn't, an exception will be
        # thrown
        os.stat(dev)
        return dev

    def get_dev_by_pci(self):
        '''Find the /dev/disk/by-path/ based on the controller pci address
        and the disk's sas address'''

        # Verify that all information needed to generate the device name exists
        sas_address = getattr(self, 'sas_address', None)
        controller = getattr(self, 'controller', None)

        if sas_address is None:
            raise Exception('No sas_address attribute, cannot find /dev/disk/by-path')

        if controller is None:
            raise Exception('No controller attributes for controller %s. Perhaps that controller does not exist?' % controller)

        pci_address = getattr(self.controller, 'pci_address', None)

        if pci_address is None:
            raise Exception('Controller %s does not have a pci_address attribute' % controller)

        # Generate the device name
        dev = '/dev/disk/by-path/pci-%s-sas-0x%s-lun-0' % (pci_address, sas_address)

        # Verify device exists. Exception will be thrown if not
        os.stat(dev)
        return dev

class DiskOld:
    @classmethod
    def all_sd(cls):
        '''Get information about all disks and find the corresponding /dev/disk/by-id and by-path information.
        Excludes partitions and devices not named ^sd[a-zA-Z]+$'''
        disks = []
        for key, value in Diskstats.info().iteritems():
            if re.match('^sd[a-zA-Z]+$', key):
                disks.append(Disk('/dev/%s' % key))

        return disks

    @classmethod
    def all_sd_sn_map(cls):
        '''Return a map of all disks, key is serial number, value is a Disk object'''
        disk_list = Disk.all_sd()

        disk_map = {}

        for disk in disk_list:
            disk_map[disk.serial_number] = disk

        return disk_map

    @classmethod
    def all_sd_wwn_map(cls):
        '''Return a map of all disks, key is wwn, value is a Disk object'''
        disk_list = Disk.all_sd()

        disk_map = {}

        for disk in disk_list:
            wwn = getattr(disk, 'wwn', None)
            if wwn is not None:
                disk_map[wwn] = disk

        return disk_map

    def __init__(self, dev):
        '''Constructor'''
        # Verify that the device exists
        stat = os.stat(dev)

        self.dev = dev
        self.hdparm = HDParm(dev)
        self.smart = Smart(dev)

        # Record this device's inode
        self.inode = stat.st_ino

        # Set the protocol. This should be discovered, but for now, we hard code it to ata
        # until I can find a good way of doing this
        self.protocol = 'ata'

        for key, value in self.hdparm.info.iteritems():
            setattr(self, key, value)

    @property
    def dev_by_id_wwn(self):
        '''/dev/disk/by-id/wwn-'''
        if getattr(self, '_dev_by_id_wwn', None) is None:
            self._dev_by_id_wwn = self.get_dev_by_id_wwn(self.wwn, self.inode)
        return self._dev_by_id_wwn

    def get_dev_by_id_wwn(self, wwn, expected_inode):
        '''Find /dev/disk/by-id/wwn-

        Params
        ------
        wwn: string
           The wwn of the disk
        expected_inode: string
           The expected inode of the resulting device. This is used as a sanity check
        '''

        dev = '/dev/disk/by-id/wwn-0x%s' % wwn

        # Check to see if the device exists. If it doesn't, an exception will be thrown
        stat = os.stat(dev)

        # Make sure that this device is pointing to the expected inode
        if stat.st_ino != expected_inode:
            raise Exception('Expected %s to have inode %s, instead it has inode %s' % (dev, expected_inode, stat.st_ino))

        return dev

    @property
    def id_sn(self):
        if getattr(self, '_id_sn', None) is None:
            self._id_sn = self.dev_by_id_sn.split('/')[-1]
        return self._id_sn

    @property
    def dev_by_id_sn(self):
        '''The path to this disk in /dev/disk/by-id/protocol-model-serial number'''
        if getattr(self, '_dev_by_id_sn', None) is None:
            self._dev_by_id_sn = self.get_dev_by_id_sn(self.protocol, self.model_number, self.serial_number, self.inode)
        return self._dev_by_id_sn

    def get_dev_by_id_sn(self, protocol, model_number, serial_number, expected_inode):
        '''Find /dev/disk/by-id/wwn-

        Params
        ------
        protocol: string
           The protocol of the disk. Only SATA and SAS are handled.
        model_number: string
           The model of the disk
        serial_number: string
           The serial number of the disk
        expected_inode: string
           The expected inode of the resulting device. This is used as a sanity check
        '''
        # Impose sanity
        model_number = model_number.replace(' ', '_')
        serial_number = serial_number.replace(' ', '_')

        if protocol == 'SATA' or protocol == 'ata':
            protocol = 'ata'
        elif protocol == 'SAS':
            protocol = 'sas'
        else:
            raise Exception('Protocol %s not recognized, cannot find /dev/disk/by-id/PROTOCOL')

        dev = '/dev/disk/by-id/%s-%s_%s' % (protocol, model_number, serial_number)

        # Check to see if the device exists. If it doesn't, an exception will be
        # thrown
        stat = os.stat(dev)

        # Make sure that this device is pointing to the expected inode
        if stat.st_ino != expected_inode:
            raise Exception('Expected %s to have inode %s, instead it has inode %s' % (dev, expected_inode, stat.st_ino))

        return dev

    @property
    def speed(self):
        return self.hdparm.speed
